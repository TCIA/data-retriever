<div class="app-container" [class.dark-mode]="isDarkMode">
  
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <img [src]="isDarkMode ? 'assets/app-title-dark.svg' : 'assets/app-title.svg'" alt="TCIA" class="app-icon">
    </div>
    <div class="header-right">
      <button class="theme-toggle" (click)="isDarkMode = !isDarkMode" title="Toggle theme">
        <span class="material-icons-outlined">{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</span>
      </button>
      <div class="user-info">
        <div class="user-name">User</div>
        <div class="user-role">Developer</div>
      </div>
    </div>
  </div>

  <div class="main-grid">

    <div class="grid-section manifest-section">
      <div class="section-header">
        <span>Manifest & Destination</span>
      </div>
      <div class="section-content">
        <div class="file-input-row">
          <input type="text" [(ngModel)]="inputFilePath" class="file-input" placeholder="Path/to/the/input/manifest">
          <button (click)="onSelectInputFile()" class="browse-btn" title="Browse">
            <span class="material-icons-outlined">folder_open</span>
          </button>
        </div>
        <div class="file-input-row">
          <input type="text" [(ngModel)]="outputDirPath" class="file-input" placeholder="Path/to/the/output/directory">
          <button (click)="onSelectOutputDirectory()" class="browse-btn" title="Browse">
            <span class="material-icons-outlined">folder_open</span>
          </button>
        </div>
      </div>
      <div class="action-bar">
        <button (click)="onFetchFiles()" class="fetch-btn" [disabled]="!inputFilePath || !outputDirPath">
          <span class="material-icons-outlined">file_download</span>
          Fetch Files
        </button>
        <button (click)="onCancelDownload()" class="fetch-btn cancel-btn" [disabled]="!((overview$ | async)?.active)">
          <span class="material-icons-outlined">cancel</span>
          Cancel
        </button>
      </div>
    </div>

    <div class="grid-section settings-section" [class.collapsed]="settingsCollapsed">
      <div class="section-header" (click)="settingsCollapsed = !settingsCollapsed">
        <span>Advanced Settings</span>
        <span class="material-icons-outlined collapse-icon">
          {{ settingsCollapsed ? 'expand_more' : 'expand_less' }}
        </span>
      </div>
      <div class="section-content">
        <div class="settings-grid">
          <div class="setting-item">
            <label class="setting-label">Max Connections</label>
            <input type="number" [(ngModel)]="maxConnections" min="1" class="setting-input">
          </div>
          <div class="setting-item">
            <label class="setting-label">Max Retries</label>
            <input type="number" [(ngModel)]="maxRetries" min="0" class="setting-input">
          </div>
          <div class="setting-item">
            <label class="setting-label">Simultaneous Downloads</label>
            <input type="number" [(ngModel)]="simultaneousDownloads" min="1" class="setting-input">
          </div>
          <div class="setting-item">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="downloadInParallel" class="setting-checkbox">
              Download In Parallel
            </label>
          </div>
          <div class="setting-item">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="skipExisting" class="setting-checkbox">
              Skip Existing
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="grid-section downloads-section" [class.collapsed]="downloadsCollapsed">
      <ng-container *ngIf="overview$ | async as overview">
        <div class="section-header downloads-header" (click)="downloadsCollapsed = !downloadsCollapsed">
          <div class="downloads-header-content">
            <span class="downloads-title">Active Downloads</span>
            <span class="downloads-percentage">{{ overview.progressPercent }}%</span>
            <span class="material-icons-outlined collapse-icon">
              {{ downloadsCollapsed ? 'expand_more' : 'expand_less' }}
            </span>
          </div>
          <div class="downloads-progress-bar">
            <div class="downloads-progress-fill" [style.width.%]="overview.progressPercent"></div>
          </div>
          <div class="downloads-meta">
            <span>{{ overview.completed }} completed</span>
            <span>{{ overview.failed }} failed</span>
            <span>{{ overview.skipped }} skipped</span>
            <span>{{ overview.cancelled }} cancelled</span>
            <span>{{ overview.active }} in progress</span>
          </div>
        </div>
      </ng-container>
      <div class="section-content downloads-content">
        <ng-container *ngIf="manifest$ | async as manifest">
          <div *ngIf="manifest.total; else emptyDownloads" class="sources-cards">
            <app-manifest-download-card [manifest]="manifest"></app-manifest-download-card>
          </div>
        </ng-container>
        <ng-template #emptyDownloads>
          <div class="empty-state">
            <span class="material-icons-outlined">hourglass_empty</span>
            <p>No downloads queued.</p>
            <small>Select a manifest and start a download to see progress.</small>
          </div>
        </ng-template>
      </div>
    </div>

    <div class="grid-section output-section" [class.collapsed]="outputCollapsed">
      <div class="section-header" (click)="outputCollapsed = !outputCollapsed">
        <span>Output</span>
        <span class="material-icons-outlined collapse-icon">
          {{ outputCollapsed ? 'expand_more' : 'expand_less' }}
        </span>
      </div>
      <div class="output-content">
        <div class="output-summary">
          <div class="output-status" [title]="status">{{ status }}</div>
          <div class="overall-progress">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="overallProgress"></div>
            </div>
            <div class="progress-label">{{ overallProgress }}%</div>
          </div>
        </div>
        <div class="output-scroll" #outputContainer>
          <div class="output-line" *ngFor="let line of outputLogs">{{ line }}</div>
        </div>
      </div>
    </div>

  </div>
</div>
